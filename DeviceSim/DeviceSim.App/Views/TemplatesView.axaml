<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:DeviceSim.App.ViewModels"
             xmlns:models="using:DeviceSim.Core.Models"
             x:Class="DeviceSim.App.Views.TemplatesView"
             x:DataType="vm:TemplatesViewModel">

    <Grid ColumnDefinitions="300, *">
        <!-- LEFT PANEL: List -->
        <Border Grid.Column="0" BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0" Background="{StaticResource SidebarBackground}">
             <Grid RowDefinitions="Auto, *, Auto">
                 <StackPanel Grid.Row="0" Margin="10" Spacing="5">
                     <TextBlock Text="TEMPLATES" FontWeight="Bold" Foreground="{StaticResource TextSecondary}" FontSize="12" LetterSpacing="1"/>
                     <Grid ColumnDefinitions="*, Auto">
                         <Button Grid.Column="0" Content="Create New" Command="{Binding CreateNewCommand}" Classes="Accent" HorizontalAlignment="Stretch" Margin="0,0,8,0"/>
                         <Button Grid.Column="1" Content="Import" Command="{Binding ImportCommand}" Padding="10,5" ToolTip.Tip="Import JSON"/>
                     </Grid>
                 </StackPanel>

                 <ListBox Grid.Row="1" ItemsSource="{Binding Templates}" SelectedItem="{Binding SelectedTemplate}" Background="Transparent">
                     <ListBox.ItemTemplate>
                         <DataTemplate>
                             <StackPanel Spacing="2">
                                 <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                 <TextBlock Text="{Binding Protocol}" FontSize="11" Foreground="#888888"/>
                             </StackPanel>
                         </DataTemplate>
                     </ListBox.ItemTemplate>
                 </ListBox>
                 
                 <StackPanel Grid.Row="2" Margin="10" Spacing="5">
                      <Button Content="Duplicate" Command="{Binding DuplicateCommand}" HorizontalAlignment="Stretch" Padding="10,8"/>
                      <Button Content="Delete Template" Command="{Binding DeleteCommand}" Classes="Danger" HorizontalAlignment="Stretch" Padding="10,8"/>
                 </StackPanel>
             </Grid>
        </Border>

        <!-- RIGHT PANEL: Editor -->
        <Border Grid.Column="1" Classes="MainPanel" Margin="20">
            <Panel>
                <ContentControl Content="{Binding EditorViewModel}">
                    <ContentControl.ContentTemplate>
                        <DataTemplate DataType="vm:TemplateEditorViewModel">
                            <Grid RowDefinitions="Auto, *, Auto">
                                
                                <!-- Header / Metadata -->
                                <StackPanel Grid.Row="0" Spacing="15">
                                    <TextBlock Text="Template Configuration" FontSize="22" FontWeight="SemiBold" Foreground="{StaticResource AccentMain}"/>
                                    
                                     <Grid ColumnDefinitions="Auto, *, Auto, Auto" RowDefinitions="Auto, Auto" >
                                         <TextBlock Grid.Row="0" Grid.Column="0" Text="Name:" VerticalAlignment="Center" Width="80" Foreground="{StaticResource TextSecondary}"/>
                                         <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Name}" Margin="0,0,15,8"/>
                                         
                                         <TextBlock Grid.Row="0" Grid.Column="2" Text="ID:" VerticalAlignment="Center" Width="40" Foreground="{StaticResource TextSecondary}"/>
                                         <TextBox Grid.Row="0" Grid.Column="3" Text="{Binding Id}" IsReadOnly="True" Width="180" Margin="0,0,0,8" Foreground="{StaticResource TextMuted}" BorderThickness="0" Background="#111"/>

                                         <TextBlock Grid.Row="1" Grid.Column="0" Text="Protocol:" VerticalAlignment="Center" Foreground="{StaticResource TextSecondary}"/>
                                         <ComboBox Grid.Row="1" Grid.Column="1" ItemsSource="{Binding Source={x:Static vm:TemplateEditorViewModel.ProtocolTypes}}" 
                                                   SelectedItem="{Binding Protocol}" Margin="0,0,15,0" IsEnabled="False" HorizontalAlignment="Stretch"/> 
                                         
                                         <TextBlock Grid.Row="1" Grid.Column="2" Text="Port:" VerticalAlignment="Center" Foreground="{StaticResource TextSecondary}"/>
                                         <TextBox Grid.Row="1" Grid.Column="3" Text="{Binding DefaultPort}" Width="180"/>
                                     </Grid>
                                </StackPanel>

                                <!-- Points Editor -->
                                <Grid Grid.Row="1" RowDefinitions="Auto, *" Margin="0,25,0,0">
                                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="15" Margin="0,0,0,10">
                                        <TextBlock Text="Points Definitions" FontWeight="SemiBold" FontSize="18" VerticalAlignment="Center"/>
                                        <Button Content="Add Point" Command="{Binding AddPointCommand}" Classes="Accent" Padding="15,4"/>
                                        <Button Content="Remove Selected" Command="{Binding RemovePointCommand}" 
                                                Classes="Danger" CommandParameter="{Binding #PointsGrid.SelectedItem}" Padding="15,4"/>
                                    </StackPanel>
                                    
                                    <DataGrid Grid.Row="1" Name="PointsGrid" ItemsSource="{Binding Points}" AutoGenerateColumns="False" 
                                              CanUserResizeColumns="True">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="Key" Binding="{Binding Key}" Width="150"/>
                                            <DataGridTextColumn Header="Name" Binding="{Binding Point.Name}" Width="150"/>
                                            
                                            <DataGridTemplateColumn Header="Kind" Width="120">
                                                <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding ModbusKinds}" SelectedItem="{Binding ModbusKind}" HorizontalAlignment="Stretch" BorderThickness="0" Background="Transparent"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>

                                            <DataGridTextColumn Header="Address" Binding="{Binding ModbusAddress}" Width="80"/>
                                            <DataGridTextColumn Header="Preview" Binding="{Binding NiagaraAddressPreview}" IsReadOnly="True" Width="100" Foreground="{StaticResource TextMuted}"/>

                                            <DataGridTemplateColumn Header="Type" Width="100">
                                                 <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding PointTypes}" SelectedItem="{Binding Type}" HorizontalAlignment="Stretch" BorderThickness="0" Background="Transparent"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>
                                            
                                            <DataGridTemplateColumn Header="Generator" Width="100">
                                                 <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding GeneratorTypes}" SelectedItem="{Binding GeneratorType}" HorizontalAlignment="Stretch" BorderThickness="0" Background="Transparent"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>
                                            
                                            <DataGridTextColumn Header="Scale" Binding="{Binding Scale}" Width="70"/>
                                            
                                            <DataGridTemplateColumn Header="Access" Width="110">
                                                 <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding AccessModes}" SelectedItem="{Binding Access}" HorizontalAlignment="Stretch" BorderThickness="0" Background="Transparent"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>

                                            <DataGridTemplateColumn Header="Override" Width="120">
                                                 <DataGridTemplateColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <ComboBox ItemsSource="{Binding OverrideModes}" SelectedItem="{Binding OverrideMode}" HorizontalAlignment="Stretch" BorderThickness="0" Background="Transparent"/>
                                                    </DataTemplate>
                                                </DataGridTemplateColumn.CellTemplate>
                                            </DataGridTemplateColumn>

                                        </DataGrid.Columns>
                                    </DataGrid>
                                </Grid>

                                <!-- Footer / Validation -->
                                <StackPanel Grid.Row="2" Margin="0,20,0,0">
                                     <Border Background="#331100" BorderBrush="#aa4400" BorderThickness="1" Padding="15" CornerRadius="8"
                                             IsVisible="{Binding HasErrors}" Margin="0,0,0,15">
                                         <StackPanel Orientation="Horizontal" Spacing="10">
                                             <Path Data="M13,14H11V9H13M13,18H11V16H13M1,21H23L12,2L1,21Z" Fill="#ffccaa" Width="16" Height="16" VerticalAlignment="Top" Margin="0,2,0,0"/>
                                             <TextBlock Text="{Binding ValidationErrors}" Foreground="#ffccaa" TextWrapping="Wrap"/>
                                         </StackPanel>
                                     </Border>
                                     
                                     <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Right">
                                         <Button Content="Create Device Instance" 
                                                 Command="{Binding $parent[UserControl].((vm:TemplatesViewModel)DataContext).CreateInstanceCommand}"
                                                 IsEnabled="{Binding !HasErrors}" Padding="20,10" CornerRadius="8"/>
                                         <Button Content="SAVE TEMPLATE" 
                                                 Command="{Binding $parent[UserControl].((vm:TemplatesViewModel)DataContext).SaveEditorCommand}"
                                                 Classes="Accent" Padding="30,10" FontWeight="Bold"/>
                                     </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ContentControl.ContentTemplate>
                </ContentControl>
                
                <StackPanel IsVisible="{Binding EditorViewModel, Converter={x:Static ObjectConverters.IsNull}}" 
                            VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="15">
                     <Path Data="M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20C4,21.1 4.89,22 6,22H18C19.1,22 20,21.1 20,20V8L14,2H6Z" 
                           Fill="{StaticResource TextMuted}" Width="64" Height="64" HorizontalAlignment="Center"/>
                     <TextBlock Text="Select a template from the list to view or edit" 
                                FontSize="18" Foreground="{StaticResource TextSecondary}" HorizontalAlignment="Center"/>
                </StackPanel>
            </Panel>
        </Border>
        

    </Grid>
</UserControl>
